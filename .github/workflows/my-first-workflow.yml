name: PR Validation
on: 
  pull_request:
    branches: [ main ]
jobs:
  Compile-Installer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}

#       We use Corretto Java 11 for Lambda: https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html
#       Currently amazon-corretto Java is not supported for GitHub actions on Ubuntu-latest. By default we're using Adopt JDK11
#         https://github.com/actions/virtual-environments/blob/main/images/linux/Ubuntu2004-README.md
#       We may want to either switch to using an AL2 container (to give us corretto) or contribute a new JDK to the GitHub runners
#         There is an open issue (as of 2021/06/30) requesting Corretto support: https://github.com/actions/setup-java/issues/68
#       - name: Set up JDK 11
#         uses: actions/setup-java@v2
#         with:
#           java-version: '11'
#           distribution: 'adopt'

      - run: cd installer && mvn clean compile
      - name: Comment on Compilation Failure
        uses: actions/github-script@0.3.0
        if: ${{ failure() }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue: { number: issue_number }, repo: { owner, repo }  } = context;
            github.issues.createComment({ issue_number, owner, repo, body: 'Compile failed! See GitHub Action output for results. PRs will not be merged if they break the build!' });
      - name: Comment on PR
        uses: actions/github-script@0.3.0
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue: { number: issue_number }, repo: { owner, repo }  } = context;
            github.issues.createComment({ issue_number, owner, repo, body: 'Installer Compilation Succeeded' });
  Compile-Onboarding:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - run: cd services/onboarding-service && mvn clean compile
      - name: Comment on Compilation Failure
        uses: actions/github-script@0.3.0
        if: ${{ failure() }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue: { number: issue_number }, repo: { owner, repo }  } = context;
            github.issues.createComment({ issue_number, owner, repo, body: 'Compile failed! See GitHub Action output for results. PRs will not be merged if they break the build!' });
      - name: Comment on PR
        uses: actions/github-script@0.3.0
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue: { number: issue_number }, repo: { owner, repo }  } = context;
            github.issues.createComment({ issue_number, owner, repo, body: 'Onboarding Compilation Succeeded' });
